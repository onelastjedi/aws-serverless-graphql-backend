{"version":3,"sources":["webpack:///webpack/bootstrap b8b2d4a65a7da7727180","webpack:///external \"source-map-support/register\"","webpack:///external \"aws-sdk\"","webpack:///./src/create-auth-challenge.js","webpack:///./src/lib/responses.js","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///./src/lib/ses.js","webpack:///./src/lib/sns.js"],"names":["Ses","Sns","exports","handler","event","context","callback","request","session","length","challengeName","smsCode","Math","random","toString","substr","smsParams","Message","PhoneNumber","userAttributes","phone_number","call","console","log","e","statusCode","emailToken","substring","params","Destination","ToAddresses","email","Body","Html","Charset","Data","process","env","AppUrl","Text","Subject","ReturnPath","Source","response","publicChallengeParameters","privateChallengeParameters","answer","concat","challengeMetadata","success","failure","buildResponse","body","headers","action","SES","promise","SNS"],"mappings":";AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;AC7DA,wD;;;;;;ACAA,oC;;;;;;;;;;;ACAA;;AACA;;IAAYA,G;;AACZ;;IAAYC,G;;;;AAEZC,QAAQC,OAAR,GAAkB,UAACC,KAAD,EAAQC,OAAR,EAAiBC,QAAjB,EAA8B;AAC9C,MAAIF,MAAMG,OAAN,CAAcC,OAAd,CAAsBC,MAAtB,KAAiC,CAAjC,IAAsCL,MAAMG,OAAN,CAAcG,aAAd,KAAgC,kBAA1E,EAA8F;AAC5F;AACA,QAAMC,UAAUC,KAAKC,MAAL,GAAcC,QAAd,CAAuB,EAAvB,EAA2BC,MAA3B,CAAkC,CAAlC,EAAqC,CAArC,CAAhB;;AAEA;AACA,QAAMC,YAAY;AAChBC,eAASN,UAAU,yBADH;AAEhBO,mBAAad,MAAMG,OAAN,CAAcY,cAAd,CAA6BC;AAF1B,KAAlB;;AAKA,QAAI;AACFnB,UAAIoB,IAAJ,CAAS,SAAT,EAAoBL,SAApB;AACAM,cAAQC,GAAR,CAAYZ,OAAZ;AACD,KAHD,CAGE,OAAOa,CAAP,EAAU;AACVlB,eAAS,IAAT,EAAe,8BAAckB,EAAEC,UAAhB,EAA4BD,CAA5B,CAAf;AACD;;AAED;AACA,QAAME,aAAad,KAAKC,MAAL,GAAcC,QAAd,CAAuB,EAAvB,EAA2Ba,SAA3B,CAAqC,CAArC,EAAwC,EAAxC,IAA8Cf,KAAKC,MAAL,GAAcC,QAAd,CAAuB,EAAvB,EAA2Ba,SAA3B,CAAqC,CAArC,EAAwC,EAAxC,CAAjE;;AAEA;AACA,QAAMC,SAAS;AACbC,mBAAa;AACXC,qBAAa,CAAC1B,MAAMG,OAAN,CAAcY,cAAd,CAA6BY,KAA9B;AADF,OADA;AAIbd,eAAS;AACPe,cAAM;AACJC,gBAAM;AACJC,qBAAS,OADL;AAEJC,+EAC6DC,QAAQC,GAAR,CAAYC,MADzE,0BACoGZ,UADpG;AAFI,WADF;AAMJa,gBAAM;AACJL,qBAAS,OADL;AAEJC,sEAAwDC,QAAQC,GAAR,CAAYC,MAApE,0BAA+FZ;AAF3F;AANF,SADC;AAYPc,iBAAS;AACPN,mBAAS,OADF;AAEPC,gBAAM;AAFC;AAZF,OAJI;AAqBbM,kBAAY,eArBC;AAsBbC,cAAQ;AAtBK,KAAf;;AAyBA,QAAI;AACF1C,UAAIqB,IAAJ,CAAS,WAAT,EAAsBO,MAAtB;AACD,KAFD,CAEE,OAAOJ,CAAP,EAAU;AACVlB,eAAS,IAAT,EAAe,8BAAckB,EAAEC,UAAhB,EAA4BD,CAA5B,CAAf;AACD;;AAED;AACApB,UAAMuC,QAAN,CAAeC,yBAAf,GAA2C,EAA3C;AACAxC,UAAMuC,QAAN,CAAeE,0BAAf,GAA4C,EAA5C;AACAzC,UAAMuC,QAAN,CAAeE,0BAAf,CAA0CC,MAA1C,GAAmDpB,WAAWqB,MAAX,CAAkBpC,OAAlB,CAAnD;AACAP,UAAMuC,QAAN,CAAeK,iBAAf,GAAmC,wBAAnC;AACD;AACD1C,WAAS,IAAT,EAAeF,KAAf;AACD,CA5DD,C;;;;;;;;;;;;;;;;;QCJgB6C,O,GAAAA,O;QAIAC,O,GAAAA,O;QAIAC,a,GAAAA,a;;;;;;AART,SAASF,OAAT,CAAkBG,IAAlB,EAAwB;AAC7B,SAAOD,cAAc,GAAd,EAAmBC,IAAnB,CAAP;AACD;;AAEM,SAASF,OAAT,CAAkBE,IAAlB,EAAwB;AAC7B,SAAOD,cAAc,GAAd,EAAmBC,IAAnB,CAAP;AACD;;AAEM,SAASD,aAAT,CAAwB1B,UAAxB,EAAoC2B,IAApC,EAA0C;AAC/C,SAAO;AACL3B,gBAAYA,UADP;AAEL4B,aAAS;AACP,qCAA+B,GADxB;AAEP,0CAAoC;AAF7B,KAFJ;AAMLD,UAAM,yBAAeA,IAAf;AAND,GAAP;AAQD,C;;;;;;ACjBD,iE;;;;;;;;;;;;;;;;ACAA;;;;;;AAEO,IAAM/B,sBAAO,SAAPA,IAAO,CAACiC,MAAD,EAAS1B,MAAT,EAAoB;AACtC,MAAM5B,MAAM,IAAI,iBAAIuD,GAAR,EAAZ;AACA,SAAOvD,IAAIsD,MAAJ,EAAY1B,MAAZ,EAAoB4B,OAApB,EAAP;AACD,CAHM,C;;;;;;;;;;;;;;;;ACFP;;;;;;AAEO,IAAMnC,sBAAO,SAAPA,IAAO,CAACiC,MAAD,EAAS1B,MAAT,EAAoB;AACtC,MAAM3B,MAAM,IAAI,iBAAIwD,GAAR,EAAZ;AACA,SAAOxD,IAAIqD,MAAJ,EAAY1B,MAAZ,EAAoB4B,OAApB,EAAP;AACD,CAHM,C","file":"src/create-auth-challenge.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap b8b2d4a65a7da7727180","module.exports = require(\"source-map-support/register\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"source-map-support/register\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"aws-sdk\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"aws-sdk\"\n// module id = 1\n// module chunks = 0","import { buildResponse } from './lib/responses'\nimport * as Ses from './lib/ses'\nimport * as Sns from './lib/sns'\n\nexports.handler = (event, context, callback) => {\n  if (event.request.session.length === 0 && event.request.challengeName === 'CUSTOM_CHALLENGE') {\n    // Create code for sms\n    const smsCode = Math.random().toString(10).substr(2, 6)\n\n    // Send the code via Amazon SNS Global SMS\n    const smsParams = {\n      Message: smsCode + ' is your DHC login code',\n      PhoneNumber: event.request.userAttributes.phone_number\n    }\n\n    try {\n      Sns.call('publish', smsParams)\n      console.log(smsCode)\n    } catch (e) {\n      callback(null, buildResponse(e.statusCode, e))\n    }\n\n    // Create token for email\n    const emailToken = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\n\n    // Send the token via Amazon SES\n    const params = {\n      Destination: {\n        ToAddresses: [event.request.userAttributes.email]\n      },\n      Message: {\n        Body: {\n          Html: {\n            Charset: 'UTF-8',\n            Data:\n              `Login with this link and code from your phone: <a href=\"${process.env.AppUrl}verify?emailToken=${emailToken}\">login</a>`\n          },\n          Text: {\n            Charset: 'UTF-8',\n            Data: `Login with this link and code from your phone: ${process.env.AppUrl}verify?emailToken=${emailToken}`\n          }\n        },\n        Subject: {\n          Charset: 'UTF-8',\n          Data: 'Login to DHC App'\n        }\n      },\n      ReturnPath: 'mi3ta@sent.as',\n      Source: 'mi3ta@sent.as'\n    }\n\n    try {\n      Ses.call('sendEmail', params)\n    } catch (e) {\n      callback(null, buildResponse(e.statusCode, e))\n    }\n\n    // Set the return parameters, including the correct answer\n    event.response.publicChallengeParameters = {}\n    event.response.privateChallengeParameters = {}\n    event.response.privateChallengeParameters.answer = emailToken.concat(smsCode)\n    event.response.challengeMetadata = 'PASSWORDLESS_CHALLENGE'\n  }\n  callback(null, event)\n}\n\n\n// WEBPACK FOOTER //\n// ./src/create-auth-challenge.js","export function success (body) {\n  return buildResponse(200, body)\n}\n\nexport function failure (body) {\n  return buildResponse(500, body)\n}\n\nexport function buildResponse (statusCode, body) {\n  return {\n    statusCode: statusCode,\n    headers: {\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Credentials\": true\n    },\n    body: JSON.stringify(body)\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/responses.js","module.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/json/stringify\"\n// module id = 4\n// module chunks = 0","import AWS from 'aws-sdk'\n\nexport const call = (action, params) => {\n  const Ses = new AWS.SES()\n  return Ses[action](params).promise()\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/ses.js","import AWS from 'aws-sdk'\n\nexport const call = (action, params) => {\n  const Sns = new AWS.SNS()\n  return Sns[action](params).promise()\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/sns.js"],"sourceRoot":""}